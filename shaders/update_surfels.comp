#version 450

#include "lib/surfels.glsl"

// -------------------------------- I/O --------------------------------

layout(local_size_x = 64) in;

layout(set = 0, binding = 0) uniform Model_Inline {
    InstanceData instance;
    uint instance_index;
};

layout(set = 0, binding = 1) readonly buffer InSurfels {
    Surfel surfels[];
};

layout(set = 0, binding = 2) writeonly buffer OutSurfels {
    Surfel out_surfels[];
};

layout(set = 0, binding = 3) writeonly buffer OutInstances {
    InstanceData out_instances[];
};

// -------------------------------- MAIN --------------------------------

void main() {
    if(gl_GlobalInvocationID.x >= instance.surfel_count) {
        return;
    }

    Surfel surfel = surfels[gl_GlobalInvocationID.x];
    surfel.pos = (instance.model * vec4(surfel.pos.xyz, 1.0)).xyz;
    surfel.area *= sqr(instance.scale);
    out_surfels[gl_GlobalInvocationID.x + instance.surfel_offset] = surfel;

    if(gl_GlobalInvocationID.x == 0) {
        out_instances[instance_index] = instance;
    }
}

